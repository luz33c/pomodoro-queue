# 番茄钟效率助手 · 产品需求文档 V2（任务驱动 + 今日任务）

> 本文为 **V2 正式版 PRD**，在 V1“自由番茄队列（无限执行）”的基础上新增：
> 1) **今日任务（To‑Do List）**；2) **基于当前任务创建番茄钟队列**（任务驱动队列，静态时间线）；3) **底部固定导航**（番茄钟 / 今日任务）。
> 目标：让设计与前端在无口头补充的条件下，直接产出可交付实现。

---

## 1. 目标与范围
- **目标**：
  - 新增“今日任务”模块，并支持从该列表一键生成**任务驱动番茄队列**（下称“任务队列”）。
  - 在界面底部（默认）提供**固定菜单切换**：左“番茄钟”（含队列与计时），右“今日任务”。
- **范围**：移动优先；单端本地数据（无账号/云同步）。
- **延续**：V1 的**自由队列（无限执行）**保持可用，任务队列为新增可选模式。
- **非目标**：团队协作、跨端同步、复杂统计报表（后续版本）。

---

## 2. 术语与命名（与 V1 保持一致 + 新增）
- **专注段（work）/ 短休息 / 长休息 / 长休间隔（longEvery）**：同 V1。
- **番茄队列（Queue）**：由 work/break 组成的执行序列。
  - **自由队列（Free）**：运行期**动态产生下一段**，无限执行，直到终止。
  - **任务队列（Task-based）**：基于任务与规则**一次性生成静态时间线**，可以预览与修改后开始执行。
- **今日任务（Tasks）**：用户当日的任务清单；生成任务队列时作为输入数据源。
- **底部导航（Tab Bar）**：左“番茄钟”，右“今日任务”。

---

## 3. 信息架构（IA）与导航

### 3.1 底部固定菜单（Tab Bar）
- **结构**：
  - **左**：`番茄钟`（图标：时钟）。进入计时仪表盘 + 队列视图。
  - **右**：`今日任务`（图标：列表）。进入任务清单视图。
- **行为**：
  - 高亮当前 Tab；点击已高亮 Tab 回到其首页（滚动置顶）。
  - 首次进入默认落在“番茄钟”；记忆上次 Tab（可选）。
  - 移动端触达面积 ≥ 44×44 pt；图标+文字；暗色模式适配。

### 3.2 主要页面
- **番茄钟（Home/Queue）**：沿用 V1 布局（计时环 + 主操作 + 历史）；支持查看当前运行的**自由队列**或**任务队列**。
- **今日任务（Tasks）**：任务列表、任务输入/编辑；顶部新增**一键创建按钮**（见 §4）。

---

## 4. 核心新增：根据当前任务创建番茄钟队列（任务驱动）

### 4.1 入口与文案
- **位置**：**今日任务页**列表顶部，固定展示一个主按钮，样式为主色 CTA。
- **中文文案**：
  - 首选：**「根据当前任务创建番茄钟队列」**
  - 备选：**「使用当前任务创建番茄钟队列」**
- **显隐**：当列表为空时，按钮仍显示，但点击后弹出空态引导（先添加任务）。

### 4.2 任务界面（Tasks）交互补充
- 列表项支持：新增、编辑文本、删除、完成/未完成切换、排序（长按拖拽）。
- 任务用于“今日”语义即可，不做多项目/多清单区分（V2 不强制复杂结构）。
- **默认选择规则**：在后续向导的“选择任务”步骤中，默认勾选**所有未完成任务**，并按当前列表顺序带入。

### 4.3 创建流程（任务队列向导）
> 共 **5 步**；除「任务选择」外，其余与 V1 规则一致。

1. **启动**：用户在“今日任务”点击顶部 CTA。
2. **任务选择**：
   - 展示所有任务（默认已勾选未完成项），可**勾选/取消**和**拖动排序**。
   - 允许快速“全选/全不选”。至少需选 1 项才能下一步。
3. **设置规则**：
   - 可编辑字段：`专注时长（默认25m）`、`短休（5m）`、`长休（20m）`、`长休间隔（4）`。
   - 校验与 V1 相同：`longEvery ≥ 2`；时长可为 0（代表无休）。
4. **规划番茄数**：
   - 系统为每个被选中的任务给出**预估番茄数**（“AI 估算”占位；若无服务则用本地启发式，如按文本长度/关键词给 1–6）。
   - 用户可逐项 `- / 数字 / +` 调整；至少为 1。
5. **最终预览与生成**：
   - 生成**静态时间线**预览：按任务顺序将每个任务拆为 N 个 work 段，并在相邻 work 之间按规则插入短/长休；**末尾不添加多余休息**。
   - 显示总时长估计（ETA）；支持返回更改；点击**「生成队列并开始」**即写入并跳转到“番茄钟”开始执行。

### 4.4 执行模型（任务队列）
- **静态时间线**：一次性生成 `work/break` 序列；执行时**顺序推进**，直至完成或被终止。
- **自动衔接**：一个段结束后自动开始下一段（无人工确认）。
- **终止**：
  - 用户可随时在“番茄钟”页点击“终止队列”。
  - 终止后：当前段记入历史；后续**未执行项**在时间线中标记为 `未执行`（灰显）。
- **与任务脱钩**：队列生成后与“今日任务”列表**无耦合**——后续改动列表不影响已生成队列。

---

## 5. 关键界面与组件（移动优先）

### 5.1 新增/调整的组件
- **`TabBar`**（底部固定导航）
  - Props：`activeTab: 'pomodoro'|'tasks'`；Events：`onChange(tab)`。
- **`TasksScreen`**（今日任务）
  - 子组件：
    - **`CreateFromTasksCTA`**（顶部主按钮，文案见 §4.1）
    - `TaskInput`（新增任务）
    - `TaskList`（含拖拽排序） / `TaskItem`（完成/编辑/删除）
- **`TaskQueueWizard`**（任务队列向导）
  - `TaskPickStep`（勾选+排序，默认勾选未完成）
  - `RuleStep`（work/short/long/longEvery）
  - `PlanStep`（每任务番茄数估计与手调）
  - `PreviewStep`（静态时间线预览 + ETA）
- **`QueueScreen`**（番茄队列视图）
  - `StaticTimeline`（任务队列专用，显示剩余/已完成/未执行）
  - `Controls`（暂停/继续/终止）

### 5.2 视觉规范（与 V1 对齐）
- **计时环**、主按钮、等宽数字、阴影与圆角半径沿用 V1。
- **任务列表**：行高 ≥ 52px；复选框、拖拽句柄；空态插画与文案。
- **TabBar**：圆角容器 + 投影；选中态主色；图标+文字；与示例图风格一致。

---

## 6. 业务规则与算法（任务队列）

### 6.1 队列生成规则（静态）
- 对每个被选中任务 `t`：按 `pomodoros = max(1, 估算/手调值)` 生成 `pomodoros` 个 `work` 段，命名为 `t.title`（可附“第 i/共 n 个”小标签）。
- 每个 `work` 段后**尝试**插入休息：
  - 若该 `work` 是**最后一个** → 不插入；
  - 否则按 `longEvery` 规则在跨任务累计的 `workCount` 上判定：命中则插入 `longBreak`，否则插入 `shortBreak`；允许休息为 0。
- 末尾永远**不添加**多余休息。

### 6.2 ETA 估算
- 在预览页显示总耗时估计：`sum(duration)`，并以 `现在 + 总时长` 估算完成时间。

---

## 7. 交互流程（文字版原型）

**A. 从 TabBar 进入任务 → 一键生成队列**
1) 用户点击底部 TabBar 的“今日任务”。
2) 点击列表顶部按钮 **「根据当前任务创建番茄钟队列」**。
3) 进入向导：默认勾选未完成任务 → 下一步设置规则 → 下一步规划番茄数 → 预览 → 生成并开始。
4) 自动切换到“番茄钟”页并开始执行任务队列。

**B. 队列执行中（番茄钟页）**
- 计时环显示当前段与剩余时间；
- 下方可 **暂停/继续/终止**；
- 时间线视图中：已完成项打勾并显示完成时刻；未执行项保持灰显。

**C. 空态与异常**
- 当“今日任务”为空时，点击顶部 CTA 弹出提示：“先添加至少 1 个任务再创建队列”。
- 若向导中用户最终未勾选任何任务 → 禁止进入下一步，并提示。

---

## 8. 数据（轻约束）
> V2 对 To‑Do 的数据结构**不做强约束**，但建议：

```ts
// 建议的最小结构（供实现时参考，可替换）
interface Task { id: string; title: string; done: boolean; note?: string }
interface PlannedTask extends Task { pomodoros: number }
// 任务队列最终为静态 QueueItem[]；自由队列仍采用 V1 的“流式下一段”模型。
```

---

## 9. 验收标准（关键用例）
1. **入口位置正确**：任务页列表**顶部**存在主按钮，文案为「根据当前任务创建番茄钟队列」。
2. **任务选择默认**：默认勾选未完成任务；可全选/全不选；至少 1 项方可继续。
3. **规则校验**：`longEvery ≥ 2`；时长允许 0；非法输入有清晰报错。
4. **番茄数规划**：每项支持 `- / 数字 / +`；下限 1；可一键重置为系统估计值。
5. **时间线预览正确**：
   - work 段之间按 `longEvery` 规则插入短/长休；
   - 队列**末尾无多余休息**；
   - 预览显示总时长与完成 ETA。
6. **生成与执行**：点击“生成队列并开始”后，立刻跳转“番茄钟”并进入第一段；段落完成会**自动衔接**下一段。
7. **终止语义**：终止后当前段写入历史，余下未执行项标记为未执行；返回“今日任务”不影响已生成队列。
8. **TabBar 行为**：可在“番茄钟/今日任务”间切换；当前 Tab 高亮；返回当前 Tab 顶部。

---

## 10. 事件与埋点（建议）
- `tab_switch`（pomodoro↔tasks）
- `queue_create_from_tasks_click`（进入向导）
- `task_pick_next`（记录任务数量）
- `rules_confirm`（记录参数）
- `plan_confirm`（记录任务与番茄数）
- `queue_generated`（任务队列） / `queue_started` / `queue_terminated`
- `segment_complete`（类型与耗时）

---

## 11. 边界与错误处理
- 任务为空 → 阻止向导继续；给出引导添加任务。
- 所有时长字段为 0 → 仍可生成（形成“无休息”流），但需二次确认提示。
- 预览页若更改顺序/番茄数后返回修改任务/规则 → 需要**重新计算**预览。
- 由于本地实现，不依赖网络；若未来接入“AI 估算”，需提供超时回退到本地启发式。

---

## 12. 非功能性
- **移动优先**：触达面积、对比度、动画（≤120ms）与暗色模式对齐 V1。
- **性能**：计时基于时间戳回算；预览生成在 100ms 内完成（100 项任务上限下）。
- **可访问性**：按钮 aria‑label、语义化标签、读取顺序合理。

---

## 13. 交付清单与排期（建议）
- **设计**：
  1) TabBar 与“今日任务”列表页（含顶部 CTA）；
  2) 任务队列向导四步 UI（任务选择/规则/番茄数规划/预览）；
  3) 番茄钟页增加“静态时间线”视图态（与自由队列共存）。
- **前端**：
  1) 新增 Tasks 模块与本地持久化；
  2) 向导流程与静态队列生成器；
  3) 队列执行/终止与历史；
  4) TabBar 路由与状态管理。
- **时间建议**：2 周：第 1 周（Tasks + 向导 + 生成器），第 2 周（执行逻辑 + 视觉收尾 + QA）。

---

## 14. 示例文案（Microcopy）
- 顶部 CTA：**根据当前任务创建番茄钟队列**
- 任务为空提示：**“还没有任务，先添加 1 条再创建队列吧。”**
- 规则说明：**“完成 N 个专注后自动安排一次长休息。”**
- 预览说明：**“这是即将执行的完整时间线。确认后立即开始。”**

---

> 补充：若你需要，我可以把 V1 的 HTML 预览扩展为 V2 的 demo（含 Tasks 页、TabBar、向导与静态时间线），方便团队先跑通一版端到端体验。

